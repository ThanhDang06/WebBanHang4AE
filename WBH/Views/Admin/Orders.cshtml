@model IEnumerable<WBH.Models.Order>

@{
    ViewBag.Title = "OrderDetails";
    Layout = "~/Views/Shared/WBH.cshtml";
}
<h2>Quản lý đơn hàng</h2>
<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Khách hàng</th>
            <th>Điện thoại</th>
            <th>Địa chỉ</th>
            <th>Thanh toán</th>
            <th>
            Ngày đặt
                <select id="sortDate" class="form-control">
                    <option value="">Mặc định</option>
                    <option value="date_desc" @(ViewBag.CurrentSort == "date_desc" ? "selected" : "")>Mới nhấtt</option>
                    <option value="date_asc" @(ViewBag.CurrentSort == "date_asc" ? "selected" : "")>Cũ nhất</option>
                </select></th>
            <th>Tổng tiền</th>
            <th>
                Trạng thái
                <div class="dropdown d-inline ms-2">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        @ViewBag.CurrentStatus ?? "Mặc định"
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                        <li><a class="dropdown-item status-filter" href="#" data-status="">Mặc định</a></li>
                        <li><a class="dropdown-item status-filter" href="#" data-status="Đã hủy">Đã hủy</a></li>
                        <li><a class="dropdown-item status-filter" href="#" data-status="Đang xử lý">Đang xử lý</a></li>
                        <li><a class="dropdown-item status-filter" href="#" data-status="Hoàn thành">Hoàn thành</a></li>
                    </ul>
                </div>
            </th>
            <th>Chi tiết</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            int stt = 1;
            foreach (var order in Model)
            {
                <tr>
                    <td>@stt</td>
                    <td>@order.FullName</td>
                    <td>@order.Phone</td>
                    <td>@(string.IsNullOrEmpty(order.AddressDelivery) ? "-" : order.AddressDelivery)</td>
                    <td>@order.PaymentMethod</td>
                    <td>@(order.DateOrder.HasValue ? order.DateOrder.Value.ToString("dd/MM/yyyy") : "-")</td>
                    <td>@(order.Total.HasValue ? ((order.Total.Value - (order.Discount ?? 0)).ToString("N0") + "₫") : "0₫") </td>
                    <td>
                        @{
                            string statusClass = "bg-secondary"; // mặc định
                            if (order.Status == "Hoàn thành") { statusClass = "bg-success"; }
                            else if (order.Status == "Đang xử lý") { statusClass = "bg-warning"; }
                            else if (order.Status == "Đã hủy") { statusClass = "bg-danger"; }
                        }
                        <select class="order-status @statusClass"
                                data-order-id="@order.IDOrder"
                                data-update-url="@Url.Action("UpdateOrderStatus", "Admin")">
                            <option value="Đang xử lý" @(order.Status == "Đang xử lý" ? "selected" : "")>Đang xử lý</option>
                            <option value="Hoàn thành" @(order.Status == "Hoàn thành" ? "selected" : "")>Hoàn thành</option>
                            <option value="Đã hủy" @(order.Status == "Đã hủy" ? "selected" : "")>Đã hủy</option>
                        </select>
                    </td>
                    <td>
                        <a href="@Url.Action("OrderDetails", "Admin", new { id = order.IDOrder })" class="btn btn-sm btn-primary">
                            Xem
                        </a>
                    </td>
                </tr>
                stt++;
            }
        }
        else
        {
            <tr>
                <td colspan="9" class="text-center">Chưa có đơn hàng nào</td>
            </tr>
        }
    </tbody>
</table>
<script src="@Url.Content("~/Scripts/jquery-3.7.0.min.js")"></script>
<script>
   $(document).ready(function(){

    $('.status-filter').click(function(e){
        e.preventDefault();
        var status = $(this).data('status'); // giá trị trạng thái chọn
        var dateSort = $('#sortDate').val(); // lấy giá trị sort theo ngày
        var url = '@Url.Action("Orders","Admin")';
        var qs = [];
        if(status) qs.push('statusFilter=' + encodeURIComponent(status));
        if(dateSort) qs.push('sortOrder=' + dateSort);
        window.location.href = url + (qs.length ? '?' + qs.join('&') : '');
    });

    $('#sortDate').change(function(){
        var status = $('#statusDropdown').text().trim(); // lấy trạng thái hiện tại từ button
        var dateSort = $(this).val();
        var url = '@Url.Action("Orders","Admin")';
        var qs = [];
        if(status && status !== "Mặc định") qs.push('statusFilter=' + encodeURIComponent(status));
        if(dateSort) qs.push('sortOrder=' + dateSort);
        window.location.href = url + (qs.length ? '?' + qs.join('&') : '');
    });

    // AJAX update status
    $('.order-status').change(function () {
        var select = $(this);
        var orderId = select.data('order-id');
        var status = select.val();
        var url = select.data('update-url');

        $.ajax({
            url: url,
            type: 'POST',
            data: { id: orderId, status: status },
            success: function(response){
                if(response.success){
                    var color = 'secondary';
                    if(status==="Hoàn thành") color='success';
                    else if(status==="Đang xử lý") color='warning';
                    else if(status==="Đã hủy") color='danger';

                    select.removeClass('bg-success bg-warning bg-danger bg-secondary')
                          .addClass('bg-' + color);

                    $('<div class="alert alert-success mt-2">Cập nhật trạng thái thành công!</div>')
                        .insertAfter(select)
                        .delay(2000)
                        .fadeOut(500,function(){ $(this).remove(); });
                } else {
                    alert("Cập nhật thất bại!");
                }
            },
            error: function(){ alert("Có lỗi xảy ra, thử lại."); }
        });
    });
});
</script>
