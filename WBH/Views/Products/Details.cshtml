@model WBH.Models.Product

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/WBH.cshtml";
}

<style>
    .product-page {
        max-width: 1280px;
        margin: auto;
        padding: 40px;
        font-family: sans-serif;
        color: #222;
    }

    .product-wrapper {
        display: flex;
        gap: 60px;
        flex-wrap: wrap;
        align-items: flex-start;
    }

    .product-image {
        flex: 1;
        position: relative;
        min-width: 300px;
    }

        .product-image img {
            width: 100%;
            border-radius: 16px;
            transition: .3s;
        }

            .product-image img:hover {
                transform: scale(1.03);
            }

    .sale-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: red;
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: bold;
    }

    .product-info {
        flex: 1;
        min-width: 300px;
    }

        .product-info h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
        }

    .desc {
        font-size: 17px;
        line-height: 1.6;
        color: #555;
        margin-bottom: 24px;
    }

    .price {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 32px;
        color: #e60023;
    }

    .old-price {
        text-decoration: line-through;
        color: gray;
        font-size: 22px;
        margin-right: 12px;
    }

    .actions {
        display: flex;
        gap: 16px;
    }

    .add-cart {
        padding: 14px 28px;
        background: #111;
        color: #fff;
        border-radius: 12px;
        text-decoration: none;
        font-size: 17px;
        transition: .3s;
    }

        .add-cart:hover {
            opacity: .85;
        }

    .back {
        padding: 14px 28px;
        border: 1px solid #aaa;
        border-radius: 12px;
        color: #333;
        text-decoration: none;
        font-size: 17px;
        transition: .3s;
    }

        .back:hover {
            background: #f5f5f5;
        }

    .option-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .opt-btn, .color-btn {
        cursor: pointer;
        transition: .2s;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px 20px;
        background: #fff;
        font-size: 15px;
    }

        .opt-btn:hover, .color-btn:hover {
            border-color: #000;
        }

    .color-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
    }

        .opt-btn.selected, .color-btn.selected {
            border: 2px solid #000;
        }
    .actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .quantity-input {
        width: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        text-align: center;
        font-size: 16px;
    }

    .btn-add-cart {
        padding: 12px 24px;
        background: #111;
        color: #fff;
        border-radius: 12px;
        text-decoration: none;
        font-size: 17px;
        transition: 0.3s;
    }

        .btn-add-cart:hover {
            opacity: 0.85;
        }

    .back {
        padding: 12px 20px;
        border: 1px solid #aaa;
        border-radius: 12px;
        color: #333;
        text-decoration: none;
        font-size: 16px;
    }

        .back:hover {
            background: #f5f5f5;
        }

</style>

<div class="product-page">
    <div class="product-wrapper">
        <!-- Ảnh sản phẩm -->
        <div class="product-image">
            <img src="@Url.Content("~/Content/Img/" + Model.Image)" alt="@Model.ProductName" id="mainProductImage" />

            @if (ViewBag.SalePercent != null)
            {
                <div class="sale-badge">-@ViewBag.SalePercent%</div>
            }
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="product-info">
            <h1>@Model.ProductName</h1>
            <p class="desc">@Model.Description</p>

            <div class="price">
                @if (ViewBag.OldPrice != null)
                {
                    <span class="old-price">@String.Format("{0:N0} ₫", ViewBag.OldPrice)</span>
                }
                <span class="current-price">@String.Format("{0:N0} ₫", ViewBag.CurrentPrice)</span>
            </div>

            <!-- Chọn size -->
            <div class="product-options">
                <label>Kích thước:</label>
                <div class="option-group">
                    @foreach (var size in Model.ProductSizes)
                    {
                        <button class="opt-btn" data-size-id="@size.IDSize" data-size="@size.SizeName" @(Model.IsOutOfStock ? "disabled" : "")>@size.SizeName</button>
                    }
                </div>

                <!-- Chọn màu nếu có -->
                @if (Model.ProductColors != null && Model.ProductColors.Any())
                {
                    <label>Màu sắc:</label>
                    <div class="option-group">
                        @foreach (var color in Model.ProductColors)
                        {
                            <button class="color-btn"
                                    style="background:@color.ColorName"
                                    data-color-id="@color.IDColor"
                                    data-color-name="@color.ColorName"
                                    data-img="@Url.Content("~/Content/Img/" + color.Image)"
                                    @(Model.IsOutOfStock ? "disabled" : "")>
                            </button>
                        }
                    </div>
                }
            </div>

            <div class="actions d-flex align-items-center">
                @if (Model.IsOutOfStock)
                {
                    <span class="text-danger fw-bold px-4 py-2 rounded border">Hết hàng</span>
                }
                else
                {
                    <!-- Số lượng -->
                    <input type="number" id="quantityInput" min="1" value="1" class="quantity-input me-2" />

                    <!-- Thêm vào giỏ hàng -->
                    <a href="javascript:void(0);" class="add-cart btn-add-cart" data-id="@Model.IDProduct">🛒 Thêm vào giỏ hàng</a>
                }

                <a href="@Url.Action("ProductList","Products")" class="back ms-3">← Quay lại cửa hàng</a>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('mainProductImage');
    const colorButtons = document.querySelectorAll('.color-btn');
    const sizeButtons = document.querySelectorAll('.opt-btn');

    colorButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const newImg = btn.getAttribute('data-img');
            if (newImg && mainImage) mainImage.src = newImg;

            colorButtons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        });
    });

    sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            sizeButtons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        });
    });

    const addCartBtn = document.querySelector('.add-cart');
    if (addCartBtn) { // chỉ thêm event listener nếu nút tồn tại
        addCartBtn.addEventListener('click', () => {
            const productId = parseInt(addCartBtn.getAttribute('data-id'));
            if (isNaN(productId)) { alert('ID sản phẩm không hợp lệ!'); return; }

            const selectedSize = document.querySelector('.opt-btn.selected');
            if (!selectedSize) { alert('Vui lòng chọn kích thước!'); return; }
            const sizeId = parseInt(selectedSize.getAttribute('data-size-id'));

            let colorId = null;
            if (colorButtons.length > 0) {
                const selectedColor = document.querySelector('.color-btn.selected');
                if (!selectedColor) { alert('Vui lòng chọn màu!'); return; }
                colorId = parseInt(selectedColor.getAttribute('data-color-id'));
            }

            let quantity = parseInt(document.getElementById('quantityInput').value);
            if (isNaN(quantity) || quantity < 1) { alert('Số lượng không hợp lệ!'); return; }

            fetch('@Url.Action("AddToCart", "Carts")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    id: productId,
                    colorId: colorId,
                    sizeId: sizeId,
                    quantity: quantity
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    alert(data.message);
                    if(typeof updateCartCount === "function") updateCartCount();
                    if(typeof renderMiniCart === "function") renderMiniCart();
                } else {
                    alert(data.message || 'Lỗi thêm giỏ hàng!');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Lỗi server, vui lòng thử lại!');
            });
        });
    }
});


</script>
