@model WBH.Models.Product

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/WBH.cshtml";
}

<style>
    .product-page {
        max-width: 1280px;
        margin: auto;
        padding: 40px;
        font-family: sans-serif;
        color: #222;
    }

    .product-wrapper {
        display: flex;
        gap: 60px;
        flex-wrap: wrap;
        align-items: flex-start;
    }

    .product-image {
        flex: 1;
        position: relative;
        min-width: 300px;
    }

        .product-image img {
            width: 100%;
            border-radius: 16px;
            transition: .3s;
        }

            .product-image img:hover {
                transform: scale(1.03);
            }

    .sale-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: red;
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: bold;
    }

    .product-info {
        flex: 1;
        min-width: 300px;
    }

        .product-info h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
        }

    .desc {
        font-size: 17px;
        line-height: 1.6;
        color: #555;
        margin-bottom: 24px;
    }

    .price {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 32px;
        color: #e60023;
    }

    .old-price {
        text-decoration: line-through;
        color: gray;
        font-size: 22px;
        margin-right: 12px;
    }

    .actions {
        display: flex;
        gap: 16px;
    }

    .add-cart {
        padding: 14px 28px;
        background: #111;
        color: #fff;
        border-radius: 12px;
        text-decoration: none;
        font-size: 17px;
        transition: .3s;
    }

        .add-cart:hover {
            opacity: .85;
        }

    .back {
        padding: 14px 28px;
        border: 1px solid #aaa;
        border-radius: 12px;
        color: #333;
        text-decoration: none;
        font-size: 17px;
        transition: .3s;
    }

        .back:hover {
            background: #f5f5f5;
        }

    .option-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .opt-btn, .color-btn {
        cursor: pointer;
        transition: .2s;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px 20px;
        background: #fff;
        font-size: 15px;
    }

        .opt-btn:hover, .color-btn:hover {
            border-color: #000;
        }

    .color-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
    }

        .opt-btn.selected, .color-btn.selected {
            border: 2px solid #000;
        }
</style>

<div class="product-page">
    <div class="product-wrapper">
        <!-- Ảnh sản phẩm -->
        <div class="product-image">
            <img src="@Url.Content("~/Content/Img/" + Model.Image)" alt="@Model.ProductName" />
            @if (ViewBag.SalePercent != null)
            {
                <div class="sale-badge">-@ViewBag.SalePercent%</div>
            }
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="product-info">
            <h1>@Model.ProductName</h1>
            <p class="desc">@Model.Description</p>

            <div class="price">
                @if (ViewBag.OldPrice != null)
                {
                    <span class="old-price">@String.Format("{0:N0} ₫", ViewBag.OldPrice)</span>
                }
                <span class="current-price">@String.Format("{0:N0} ₫", ViewBag.CurrentPrice)</span>
            </div>

            <!-- Chọn size -->
            <div class="product-options">
                <label>Kích thước:</label>
                <div class="option-group">
                    @foreach (var size in Model.ProductSizes)
                    {
                        <button class="opt-btn" data-size-id="@size.IDSize" data-size="@size.SizeName">@size.SizeName</button>
                    }
                </div>

                <!-- Chọn màu nếu có -->
                @if (Model.ProductColors != null && Model.ProductColors.Any())
                {
                    <label>Màu sắc:</label>
                    <div class="option-group">
                        @foreach (var color in Model.ProductColors)
                        {
                            <button class="color-btn"
                                    style="background:@color.ColorName"
                                    data-color-id="@color.IDColor"
                                    data-color-name="@color.ColorName"
                                    data-img="@Url.Content("~/Content/Img/" + color.Image)">
                            </button>
                        }
                    </div>
                }
            </div>

            <div class="actions">
                <a href="javascript:void(0);" class="add-cart" data-id="@Model.IDProduct">🛒 Thêm vào giỏ hàng</a>
                <a href="@Url.Action("ProductList","Products")" class="back">← Quay lại cửa hàng</a>
            </div>
        </div>
    </div>
</div>

<script>
const colorButtons = document.querySelectorAll('.color-btn');
const sizeButtons = document.querySelectorAll('.opt-btn');
const mainImage = document.querySelector('.product-image img');

colorButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const newImg = btn.getAttribute('data-img');
        if (newImg) mainImage.src = newImg;

        colorButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    });
});

sizeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        sizeButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    });
});

document.querySelectorAll('.add-cart').forEach(btn => {
    btn.addEventListener('click', () => {
        const productId = btn.getAttribute('data-id');
        const selectedSize = document.querySelector('.opt-btn.selected');

        // Kiểm tra size
        if (!selectedSize) {
            alert('Vui lòng chọn kích thước!');
            return;
        }

        // Kiểm tra màu nếu có
        let selectedColor = null;
        if (colorButtons.length > 0) {
            selectedColor = document.querySelector('.color-btn.selected');
            if (!selectedColor) {
                alert('Vui lòng chọn màu sản phẩm!');
                return;
            }
        }

        const colorId = selectedColor ? parseInt(selectedColor.getAttribute('data-color-id')) : null;
        const colorName = selectedColor ? selectedColor.getAttribute('data-color-name') : null;
        const sizeId = parseInt(selectedSize.getAttribute('data-size-id'));
        const sizeName = selectedSize.getAttribute('data-size');

        fetch('@Url.Action("AddToCart", "Carts")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                id: parseInt(productId),
                colorId: colorId,
                colorName: colorName,
                sizeId: sizeId,
                sizeName: sizeName,
                quantity: 1
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                alert(data.message);
                if(typeof updateCartCount === "function") updateCartCount();
                if(typeof renderMiniCart === "function") renderMiniCart();
            } else {
                alert(data.message || 'Lỗi thêm giỏ hàng!');
            }
        })
        .catch(err => console.error(err));
    });
});
</script>
